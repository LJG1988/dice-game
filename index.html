<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
  <title>å¤šäººåœ¨çº¿Â·æ–—åœ°ä¸»æ·éª°å­ Â· å›¾å½¢éª°å­</title>
  <!-- Font Awesome 4.7 è¾…åŠ©å›¾æ ‡ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <!-- Socket.IO å®¢æˆ·ç«¯ -->
  <script src="/socket.io/socket.io.js"></script>
  <style>
    /* ===== å…¨å±€æ–—åœ°ä¸»é£æ ¼ ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Microsoft YaHei', 'Segoe UI', Roboto, sans-serif;
    }
    body {
      background: linear-gradient(145deg, #1e3c4f 0%, #0b2a3b 100%);
      height: 100vh;
      width: 100vw;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 12px;
    }
    #app {
      width: 100%;
      max-width: 800px;
      height: 100%;
      max-height: 900px;
      background: #2b5f6b;
      border-radius: 32px 32px 28px 28px;
      box-shadow: 0 15px 25px rgba(0,0,0,0.7), inset 0 1px 5px rgba(255,215,0,0.6);
      border: 3px solid #e2c28b;
      display: flex;
      flex-direction: column;
      padding: 12px 12px 10px;
      position: relative;
    }

    /* ----- ä¸Šéƒ¨åŒºåŸŸ 1/5 : åœ¨çº¿ç©å®¶åˆ—è¡¨ ----- */
    .top-panel {
      flex: 1;
      height: 0;
      background: rgba(10, 35, 45, 0.85);
      margin-bottom: 8px;
      border-radius: 24px 24px 16px 16px;
      border: 2px solid #ffd966;
      box-shadow: inset 0 -2px 5px #0e1e24, inset 0 2px 5px #ffe28b;
      display: flex;
      flex-direction: column;
      padding: 10px 12px;
      color: #ffebc2;
      overflow-y: auto;
    }
    .top-title {
      font-size: 0.9rem;
      font-weight: bold;
      color: #ffd98c;
      text-shadow: 1px 1px 0 #3d2b1a;
      margin-bottom: 6px;
      letter-spacing: 2px;
    }
    .online-players {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .player-badge {
      background: radial-gradient(circle at 30% 20%, #f7e6b4, #ca9e4b);
      padding: 6px 14px;
      border-radius: 30px;
      color: #2d1f0b;
      font-weight: bold;
      font-size: 0.95rem;
      border: 2px solid #ffe68f;
      box-shadow: 0 0 8px #ffbf40;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .empty-tip {
      color: #b6dae0;
      font-style: italic;
      padding: 6px;
    }

    /* ----- ä¸­éƒ¨åŒºåŸŸ 3/5 : éª°å­ä¸»ç•Œé¢ + æ‰”æŒ‰é’® ----- */
    .mid-panel {
      flex: 3;
      height: 0;
      background: #124c34;
      background-image: radial-gradient(circle at 20% 30%, #276b4b, #0a3523);
      margin: 6px 0;
      border-radius: 28px;
      border: 4px solid #e6c281;
      box-shadow: inset 0 -6px 0 #6b4e28, inset 0 2px 12px #dbb45c;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px;
      position: relative;
    }
    .dice-area {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 2vw;
      margin-bottom: 20px;
    }

    /* ----- å…¨æ–°å›¾å½¢åŒ–éª°å­ï¼š3x3ç½‘æ ¼ï¼Œçº¢/é»‘åœ†ç‚¹ ----- */
    .dice {
      width: 15vw;
      height: 15vw;
      max-width: 90px;
      max-height: 90px;
      min-width: 60px;
      min-height: 60px;
      background: #fff9ed;
      border-radius: 18px;
      box-shadow: 0 8px 0 #9c7e5c, 0 12px 20px rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 8px;
      border: 2px solid #eac784;
      transform: rotate(1deg);
      transition: all 0.08s;
    }
    .dice-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 6px;
      width: 100%;
      height: 100%;
      justify-items: center;
      align-items: center;
    }
    /* éª°å­ç‚¹ï¼šé»˜è®¤çº¢è‰² */
    .pip {
      width: 70%;
      height: 70%;
      background: #c22d2d;
      border-radius: 50%;
      box-shadow: inset 0 -2px 0 #7a1f1f, inset 0 2px 5px rgba(255, 200, 200, 0.8);
      opacity: 0;
      transition: opacity 0.05s;
    }
    /* é»‘è‰²éª°å­ç‚¹ï¼ˆç”¨äº6ç‚¹ï¼Œæ›´ä¼ ç»Ÿï¼‰ */
    .pip.black {
      background: #2e2e2e;
      box-shadow: inset 0 -2px 0 #0a0a0a, inset 0 2px 5px rgba(255, 255, 255, 0.6);
    }
    .pip.active {
      opacity: 1;
    }

    /* æ‰”æŒ‰é’® */
    .roll-btn {
      background: radial-gradient(circle at 30% 20%, #ffe084, #d4a017);
      border: 4px solid #ffeaaa;
      color: #2c1c0a;
      font-size: 2.4rem;
      font-weight: 900;
      padding: 8px 40px;
      border-radius: 60px;
      box-shadow: 0 10px 0 #8b6b2c, 0 10px 25px black;
      letter-spacing: 18px;
      text-shadow: 4px 4px 0 rgba(255,215,0,0.6);
      transition: 0.08s;
      margin-top: 6px;
      cursor: pointer;
      border: 2px solid #fff1b8;
      line-height: 1;
    }
    .roll-btn:active {
      transform: translateY(8px);
      box-shadow: 0 2px 0 #6b4e28, 0 10px 20px black;
    }
    .roll-btn.disabled {
      opacity: 0.5;
      transform: none;
      box-shadow: 0 6px 0 #6b4e28;
      pointer-events: none;
    }

    /* ----- ä¸‹éƒ¨åŒºåŸŸ 1/5 : è§’è‰²åˆ—è¡¨ + é€‰è§’æ“ä½œåŒº ----- */
    .bottom-panel {
      flex: 1;
      height: 0;
      background: #1f494b;
      margin-top: 8px;
      border-radius: 20px 20px 24px 24px;
      border: 2px solid #fad373;
      box-shadow: inset 0 1px 8px #dbb058;
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    .role-list-title {
      color: #ffefb0;
      font-size: 0.8rem;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
    }
    .current-roles {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 5px 0 6px;
    }
    .role-item {
      background: #2f2a1f;
      border: 2px solid #cbb26a;
      border-radius: 24px;
      padding: 4px 12px 4px 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #ffe59c;
      font-weight: 600;
      font-size: 0.85rem;
    }
    .kai-btn {
      background: #f5cb5c;
      border: none;
      border-radius: 16px;
      padding: 4px 12px;
      color: #232323;
      font-weight: bold;
      box-shadow: 0 3px 0 #ad7c33;
      font-size: 0.8rem;
      cursor: pointer;
      margin-left: 5px;
      transition: 0.05s;
      border: 1px solid #ffecb0;
    }
    .kai-btn:active {
      transform: translateY(3px);
      box-shadow: none;
    }
    .kai-btn.hidden {
      display: none;
    }
    .role-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
      align-items: center;
      border-top: 1px dashed #eac672;
      padding-top: 8px;
    }
    .role-btn {
      background: #434343;
      color: #eee1c5;
      border: 2px solid #9c8a5a;
      border-radius: 28px;
      padding: 6px 14px;
      font-size: 0.8rem;
      font-weight: bold;
      cursor: pointer;
      transition: 0.1s;
    }
    .role-btn.available {
      background: #30663b;
      border-color: #cbb85a;
      color: white;
      box-shadow: 0 0 8px #a3d064;
    }
    .role-btn.disabled {
      opacity: 0.4;
      pointer-events: none;
      background: #555;
    }
    .user-status {
      color: #ffe6a6;
      font-size: 0.75rem;
      margin-left: auto;
    }
  </style>
</head>
<body>
<div id="app">
  <!-- ä¸Šéƒ¨ï¼šåœ¨çº¿ç©å®¶åˆ—è¡¨ -->
  <div class="top-panel">
    <div class="top-title"><i class="fa fa-users"></i> åœ¨çº¿ç©å®¶ Â· å·²å‚æˆ˜</div>
    <div id="onlineList" class="online-players">
      <span class="empty-tip">æš‚æ— ç©å®¶ï¼Œå¿«é€‰è§’è‰²åŠ å…¥å§</span>
    </div>
  </div>

  <!-- ä¸­éƒ¨ï¼šéª°å­æˆ˜åœº + æ‰”æŒ‰é’® -->
  <div class="mid-panel">
    <div id="diceContainer" class="dice-area"></div>
    <div id="rollActionBtn" class="roll-btn">æ‰”</div>
  </div>

  <!-- ä¸‹éƒ¨ï¼šæœ¬å±€è§’è‰²åˆ—è¡¨ï¼ˆå¼€æŒ‰é’®ï¼‰ + è§’è‰²é€‰æ‹©åŒº -->
  <div class="bottom-panel">
    <div class="role-list-title">
      <span><i class="fa fa-male"></i> æœ¬å±€è§’è‰²Â·å¼€ç‰Œ</span>
      <span id="gamePhaseInfo" style="color:#ffd966;">ç­‰å¾…å¼€å±€</span>
    </div>
    <div id="roleGameList" class="current-roles"></div>
    <div class="role-selector" id="roleSelectorArea">
      <span style="color:#ffe3a0; font-size:0.8rem;">é€‰è§’:</span>
    </div>
  </div>
</div>

<script>
  (function(){
    // ---------- å¼ºåˆ¶ä½¿ç”¨é•¿è½®è¯¢ï¼Œå®Œç¾å…¼å®¹Zeaburç­‰å¹³å°ï¼Œé¿å…502/WebSocketé—®é¢˜ ----------
    const socket = io({
      transports: ['polling'],
      upgrade: false
    });

    // ========== å…¨å±€å˜é‡ ==========
    let myRole = null;                // æˆ‘è‡ªå·±é€‰æ‹©çš„è§’è‰²
    let allPlayers = [];            // å½“å‰æ‰€æœ‰åœ¨çº¿è§’è‰² [{ role, id }]
    let roundDicePoints = {};       // æœ¬è½®å„ä¸ªè§’è‰²çš„éª°å­ç‚¹æ•° { role: [d1,d2,d3,d4,d5] }
    let isRolling = false;         // æ˜¯å¦æ­£åœ¨åŠ¨ç”»ä¸­
    let rollTimer = null;         
    let kaiVisibleTimer = null;   
    let currentDisplayRole = null; // ä¸­éƒ¨éª°å­æ­£åœ¨å±•ç¤ºè°çš„ç‚¹æ•°
    const FIXED_ROLES = ['å»ºå¹¿', 'å»ºå›½', 'æå·', 'å‡¯å®', 'é¸¿æ™“'];

    // ========== DOM å…ƒç´  ==========
    const onlineListDiv = document.getElementById('onlineList');
    const diceContainer = document.getElementById('diceContainer');
    const rollBtn = document.getElementById('rollActionBtn');
    const roleGameListDiv = document.getElementById('roleGameList');
    const roleSelectorArea = document.getElementById('roleSelectorArea');
    const gamePhaseInfo = document.getElementById('gamePhaseInfo');

    // ========== éª°å­å›¾å½¢åŒ–å‡½æ•° ==========
    // åˆå§‹åŒ–5ä¸ªéª°å­ï¼Œæ¯ä¸ªéª°å­å†…å»º3x3ç½‘æ ¼
    function initDiceUI() {
      diceContainer.innerHTML = '';
      for (let i = 0; i < 5; i++) {
        const diceDiv = document.createElement('div');
        diceDiv.className = 'dice';
        const grid = document.createElement('div');
        grid.className = 'dice-grid';
        // 9ä¸ªpip
        for (let p = 0; p < 9; p++) {
          const pip = document.createElement('div');
          pip.className = 'pip';
          grid.appendChild(pip);
        }
        diceDiv.appendChild(grid);
        diceContainer.appendChild(diceDiv);
      }
    }
    initDiceUI();

    // æ ¹æ®ç‚¹æ•°(1-6)æ›´æ–°å•ä¸ªéª°å­å›¾å½¢
    function updateDiceWithValue(diceElement, value) {
      const grid = diceElement.querySelector('.dice-grid');
      if (!grid) return;
      const pips = grid.children; // 9ä¸ª.pip
      // å…¨éƒ¨éšè—
      for (let i = 0; i < pips.length; i++) {
        pips[i].classList.remove('active', 'black');
      }
      // æ¿€æ´»å¯¹åº”ç´¢å¼•
      let activeIndices = [];
      switch (value) {
        case 1: activeIndices = [4]; break;
        case 2: activeIndices = [0, 8]; break;
        case 3: activeIndices = [0, 4, 8]; break;
        case 4: activeIndices = [0, 2, 6, 8]; break;
        case 5: activeIndices = [0, 2, 4, 6, 8]; break;
        case 6: activeIndices = [0, 1, 2, 6, 7, 8]; break;
        default: activeIndices = [4];
      }
      activeIndices.forEach(idx => {
        if (pips[idx]) {
          pips[idx].classList.add('active');
          // 6ç‚¹ä½¿ç”¨é»‘è‰²ï¼Œæ›´ä¼ ç»Ÿ
          if (value === 6) {
            pips[idx].classList.add('black');
          }
        }
      });
    }

    // åŒæ—¶æ›´æ–°5ä¸ªéª°å­
    function setDiceFaces(diceArray) {
      const diceDivs = document.querySelectorAll('.dice');
      diceDivs.forEach((dice, idx) => {
        if (diceArray && diceArray[idx]) {
          updateDiceWithValue(dice, diceArray[idx]);
        }
      });
    }

    // ---------- éª°å­æ»šåŠ¨åŠ¨ç”» ----------
    function startRollAnimation() {
      if (rollTimer) clearInterval(rollTimer);
      isRolling = true;
      rollBtn.classList.add('disabled');
      rollTimer = setInterval(() => {
        const diceDivs = document.querySelectorAll('.dice');
        diceDivs.forEach(div => {
          const rand = Math.floor(Math.random() * 6) + 1;
          updateDiceWithValue(div, rand);   // éšæœºå›¾å½¢
        });
      }, 80);
    }

    function stopRollAnimationAndShow(role) {
      if (rollTimer) {
        clearInterval(rollTimer);
        rollTimer = null;
      }
      isRolling = false;
      rollBtn.classList.remove('disabled');
      if (role && roundDicePoints[role]) {
        setDiceFaces(roundDicePoints[role]);
        currentDisplayRole = role;
      }
    }

    // ========== UIæ¸²æŸ“å‡½æ•° ==========
    // ä¸Šéƒ¨åœ¨çº¿åˆ—è¡¨
    function renderOnlinePlayers() {
      if (allPlayers.length === 0) {
        onlineListDiv.innerHTML = '<span class="empty-tip">æš‚æ— ç©å®¶ï¼Œå¿«é€‰è§’è‰²åŠ å…¥å§</span>';
        return;
      }
      let html = '';
      allPlayers.forEach(p => {
        html += `<div class="player-badge"><i class="fa fa-user-circle"></i> ${p.role}</div>`;
      });
      onlineListDiv.innerHTML = html;
    }

    // ä¸‹éƒ¨è§’è‰²åˆ—è¡¨ï¼ˆå¸¦å¼€æŒ‰é’®ï¼‰
    function renderRoleGameList(showKai = false) {
      if (allPlayers.length === 0) {
        roleGameListDiv.innerHTML = '<span style="color:#c7b58b;">æš‚æ— è§’è‰²</span>';
        return;
      }
      let html = '';
      FIXED_ROLES.forEach(role => {
        const player = allPlayers.find(p => p.role === role);
        if (!player) return;
        const hasDice = roundDicePoints && roundDicePoints[role];
        const kaiVisible = showKai && hasDice;
        const isActiveRole = (currentDisplayRole === role);
        const activeStyle = isActiveRole ? 'border: 3px solid #ffd966; background:#4a412a;' : '';
        html += `<div class="role-item" style="${activeStyle}">
                    <i class="fa fa-male"></i> ${role}`;
        if (hasDice) {
          html += `<span style="color:#eac358;font-size:0.7rem;">ğŸ²å·²æŠ•</span>`;
        }
        if (kaiVisible) {
          html += `<button class="kai-btn" data-role="${role}">å¼€</button>`;
        }
        html += `</div>`;
      });
      if (html === '') html = '<span style="color:#c7b58b;">æš‚æ— åœ¨çº¿è§’è‰²</span>';
      roleGameListDiv.innerHTML = html;

      // ç»‘å®šå¼€æŒ‰é’®äº‹ä»¶
      if (showKai) {
        document.querySelectorAll('.kai-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const targetRole = this.dataset.role;
            if (roundDicePoints[targetRole]) {
              setDiceFaces(roundDicePoints[targetRole]);
              currentDisplayRole = targetRole;
              renderRoleGameList(true); // åˆ·æ–°é«˜äº®
            }
          });
        });
      }
    }

    // è§’è‰²é€‰æ‹©æŒ‰é’®æ¸²æŸ“
    function renderRoleSelector() {
      const occupied = allPlayers.map(p => p.role);
      let html = '';
      FIXED_ROLES.forEach(role => {
        const isOccupied = occupied.includes(role);
        const isMe = myRole === role;
        const available = !isOccupied && !myRole;
        const cls = `role-btn ${available ? 'available' : 'disabled'}`;
        html += `<div class="${cls}" data-role="${role}">${role} ${isMe ? 'âœ“' : (isOccupied ? 'âš”ï¸' : '')}</div>`;
      });
      roleSelectorArea.innerHTML = `<span style="color:#ffe3a0; font-size:0.8rem;">é€‰è§’:</span>` + html;
    }

    // ========== Socket.IO äº‹ä»¶ç›‘å¬ ==========
    socket.on('connect', () => {
      console.log('socket connected', socket.id);
    });

    socket.on('playersUpdate', (players) => {
      allPlayers = players || [];
      if (myRole && !allPlayers.find(p => p.role === myRole)) {
        myRole = null;   // è‡ªå·±æ‰çº¿äº†
      }
      renderOnlinePlayers();
      renderRoleSelector();
      renderRoleGameList(false); // é»˜è®¤ä¸æ˜¾ç¤ºå¼€æŒ‰é’®
    });

    socket.on('roleAssigned', ({ success, role, message }) => {
      if (success) {
        myRole = role;
        currentDisplayRole = role;
        renderRoleSelector();
        if (roundDicePoints && roundDicePoints[role]) {
          setDiceFaces(roundDicePoints[role]);
          currentDisplayRole = role;
        }
      } else {
        alert(message || 'è§’è‰²é€‰æ‹©å¤±è´¥ï¼Œå¯èƒ½å·²è¢«é€‰èµ°');
      }
    });

    socket.on('startRoll', ({ roundPoints }) => {
      roundDicePoints = roundPoints || {};
      // å¼€å§‹åŠ¨ç”»
      startRollAnimation();
      gamePhaseInfo.innerText = 'ğŸ² éª°å­æ»šåŠ¨ä¸­...';
      // 2.6ç§’ååœæ­¢åŠ¨ç”»ï¼Œæ˜¾ç¤ºè‡ªå·±çš„ç‚¹æ•°
      setTimeout(() => {
        if (isRolling) {
          stopRollAnimationAndShow(myRole);
          gamePhaseInfo.innerText = 'ğŸ² ç‚¹æ•°å·²å®š Â· 15ç§’åå¼€ç‰Œ';
          if (kaiVisibleTimer) clearTimeout(kaiVisibleTimer);
          kaiVisibleTimer = setTimeout(() => {
            renderRoleGameList(true);   // æ˜¾ç¤ºå¼€æŒ‰é’®
            gamePhaseInfo.innerText = 'ğŸ‘† ç‚¹å‡»â€œå¼€â€æŸ¥çœ‹ä»–äººéª°å­';
          }, 15000);
        }
      }, 2600);
    });

    socket.on('errorMsg', ({ message }) => {
      alert(message);
    });

    // ========== ç•Œé¢äº¤äº’ ==========
    rollBtn.addEventListener('click', () => {
      if (!myRole) {
        alert('è¯·å…ˆé€‰æ‹©è§’è‰²ï¼');
        return;
      }
      if (isRolling) {
        alert('éª°å­æ­£åœ¨æ»šåŠ¨ï¼Œè¯·ç¨å');
        return;
      }
      socket.emit('playerReady', { role: myRole });
    });

    // è§’è‰²é€‰æ‹©å§”æ‰˜
    roleSelectorArea.addEventListener('click', (e) => {
      const target = e.target.closest('.role-btn');
      if (!target) return;
      if (!target.classList.contains('available')) return;
      const role = target.dataset.role;
      if (!role) return;
      if (myRole) {
        alert('ä½ å·²ç»é€‰æ‹©è¿‡è§’è‰²äº†ï¼Œä¸èƒ½æ›´æ¢');
        return;
      }
      socket.emit('selectRole', { role });
    });

    // åˆå§‹åŒ–æ¸²æŸ“
    renderRoleSelector();
  })();
</script>
</body>
</html>
