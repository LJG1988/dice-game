<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
  <title>å¤šäººåœ¨çº¿Â·æ–—åœ°ä¸»æ·éª°å­</title>
  <!-- Font Awesome 4.7 è¾…åŠ©å›¾æ ‡, å¢åŠ QQæ–—åœ°ä¸»é£æ ¼æ„Ÿ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <!-- Socket.io å®¢æˆ·ç«¯ -->
  <script src="/socket.io/socket.io.js"></script>
  <style>
    /* å…¨å±€æ–—åœ°ä¸»é£æ ¼ï¼šæ·±è“æ¸å˜ã€é‡‘è‰²è¾¹æ¡†ã€åœ†æ¶¦é˜´å½± */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Microsoft YaHei', 'Segoe UI', Roboto, sans-serif;
    }
    body {
      background: linear-gradient(145deg, #1e3c4f 0%, #0b2a3b 100%);
      height: 100vh;
      width: 100vw;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 12px;
    }
    #app {
      width: 100%;
      max-width: 800px;
      height: 100%;
      max-height: 900px;
      background: #2b5f6b; /* æ–—åœ°ä¸»ç»å…¸ç‰Œæ¡Œåº•è‰² */
      border-radius: 32px 32px 28px 28px;
      box-shadow: 0 15px 25px rgba(0,0,0,0.7), inset 0 1px 5px rgba(255,215,0,0.6);
      border: 3px solid #e2c28b;
      display: flex;
      flex-direction: column;
      padding: 12px 12px 10px;
      position: relative;
    }

    /* --- ä¸Šéƒ¨åŒºåŸŸ 1/5 : æ˜¾ç¤ºå·²é€‰è§’è‰²ç©å®¶åˆ—è¡¨(å¤´åƒé£æ ¼) --- */
    .top-panel {
      flex: 1; /* åŸºäºflex: 1 1 0, æ•´ä½“å æ¯”ç”±çˆ¶çº§flex-direction:columnæ§åˆ¶é«˜åº¦æ¯”ä¾‹ */
      height: 0; /* flexå­é¡¹æ”¶ç¼©è§„åˆ™ */
      background: rgba(10, 35, 45, 0.85);
      margin-bottom: 8px;
      border-radius: 24px 24px 16px 16px;
      border: 2px solid #ffd966;
      box-shadow: inset 0 -2px 5px #0e1e24, inset 0 2px 5px #ffe28b;
      display: flex;
      flex-direction: column;
      padding: 10px 12px;
      color: #ffebc2;
      overflow-y: auto;
    }
    .top-title {
      font-size: 0.9rem;
      font-weight: bold;
      color: #ffd98c;
      text-shadow: 1px 1px 0 #3d2b1a;
      margin-bottom: 6px;
      letter-spacing: 2px;
    }
    .online-players {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .player-badge {
      background: radial-gradient(circle at 30% 20%, #f7e6b4, #ca9e4b);
      padding: 6px 14px;
      border-radius: 30px;
      color: #2d1f0b;
      font-weight: bold;
      font-size: 0.95rem;
      border: 2px solid #ffe68f;
      box-shadow: 0 0 8px #ffbf40;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .player-badge i {
      color: #8b4513;
    }
    .empty-tip {
      color: #b6dae0;
      font-style: italic;
      padding: 6px;
    }

    /* --- ä¸­éƒ¨åŒºåŸŸ 3/5 : éª°å­ä¸»ç•Œé¢ + æ‰”æŒ‰é’® --- */
    .mid-panel {
      flex: 3;
      height: 0;
      background: #124c34; /* æ–—åœ°ä¸»ç»å…¸ç»¿å‘¢ */
      background-image: radial-gradient(circle at 20% 30%, #276b4b, #0a3523);
      margin: 6px 0;
      border-radius: 28px;
      border: 4px solid #e6c281;
      box-shadow: inset 0 -6px 0 #6b4e28, inset 0 2px 12px #dbb45c;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px;
      position: relative;
    }
    .dice-area {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 2vw;
      margin-bottom: 20px;
    }
    .dice {
      width: 15vw;
      height: 15vw;
      max-width: 80px;
      max-height: 80px;
      min-width: 55px;
      min-height: 55px;
      background: #fef9e8;
      border-radius: 16px;
      box-shadow: 0 8px 0 #7f5b3a, 0 12px 20px black;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 2.5rem;
      font-weight: 800;
      color: #3a281c;
      border: 2px solid #c8a87b;
      transform: rotate(2deg);
      transition: all 0.08s;
    }
    .roll-btn {
      background: radial-gradient(circle at 30% 20%, #ffe084, #d4a017);
      border: 4px solid #ffeaaa;
      color: #2c1c0a;
      font-size: 2.4rem;
      font-weight: 900;
      padding: 8px 40px;
      border-radius: 60px;
      box-shadow: 0 10px 0 #8b6b2c, 0 10px 25px black;
      letter-spacing: 18px;
      text-shadow: 4px 4px 0 rgba(255,215,0,0.6);
      transition: 0.08s;
      margin-top: 6px;
      cursor: pointer;
      border: 2px solid #fff1b8;
      line-height: 1;
    }
    .roll-btn:active {
      transform: translateY(8px);
      box-shadow: 0 2px 0 #6b4e28, 0 10px 20px black;
    }
    .roll-btn.disabled {
      opacity: 0.5;
      transform: none;
      box-shadow: 0 6px 0 #6b4e28;
      pointer-events: none;
    }

    /* --- ä¸‹éƒ¨åŒºåŸŸ 1/5 : å½“å‰å‚ä¸è§’è‰²åˆ—è¡¨ + æ“ä½œåŒº(è§’è‰²é€‰æ‹©) --- */
    .bottom-panel {
      flex: 1;
      height: 0;
      background: #1f494b;
      margin-top: 8px;
      border-radius: 20px 20px 24px 24px;
      border: 2px solid #fad373;
      box-shadow: inset 0 1px 8px #dbb058;
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    .role-list-title {
      color: #ffefb0;
      font-size: 0.8rem;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
    }
    .current-roles {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 5px 0 6px;
    }
    .role-item {
      background: #2f2a1f;
      border: 2px solid #cbb26a;
      border-radius: 24px;
      padding: 4px 12px 4px 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: #ffe59c;
      font-weight: 600;
      font-size: 0.85rem;
    }
    .kai-btn {
      background: #f5cb5c;
      border: none;
      border-radius: 16px;
      padding: 4px 12px;
      color: #232323;
      font-weight: bold;
      box-shadow: 0 3px 0 #ad7c33;
      font-size: 0.8rem;
      cursor: pointer;
      margin-left: 5px;
      transition: 0.05s;
      border: 1px solid #ffecb0;
    }
    .kai-btn:active {
      transform: translateY(3px);
      box-shadow: none;
    }
    .kai-btn.hidden {
      display: none;
    }
    .role-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
      align-items: center;
      border-top: 1px dashed #eac672;
      padding-top: 8px;
    }
    .role-btn {
      background: #434343;
      color: #eee1c5;
      border: 2px solid #9c8a5a;
      border-radius: 28px;
      padding: 6px 14px;
      font-size: 0.8rem;
      font-weight: bold;
      cursor: pointer;
      transition: 0.1s;
    }
    .role-btn.available {
      background: #30663b;
      border-color: #cbb85a;
      color: white;
      box-shadow: 0 0 8px #a3d064;
    }
    .role-btn.disabled {
      opacity: 0.4;
      pointer-events: none;
      background: #555;
    }
    .user-status {
      color: #ffe6a6;
      font-size: 0.75rem;
      margin-left: auto;
    }
  </style>
</head>
<body>
<div id="app">
  <!-- ä¸Šéƒ¨åŒºåŸŸï¼šå·²é€‰è§’è‰²ç©å®¶åˆ—è¡¨ï¼ˆåœ¨çº¿çŠ¶æ€ï¼‰ -->
  <div class="top-panel">
    <div class="top-title"><i class="fa fa-users" aria-hidden="true"></i> åœ¨çº¿ç©å®¶ Â· å·²å‚æˆ˜</div>
    <div id="onlineList" class="online-players">
      <span class="empty-tip">æš‚æ— ç©å®¶ï¼Œå¿«é€‰è§’è‰²åŠ å…¥å§</span>
    </div>
  </div>

  <!-- ä¸­éƒ¨åŒºåŸŸï¼šéª°å­æˆ˜åœº + æ‰”æŒ‰é’® -->
  <div class="mid-panel">
    <div id="diceContainer" class="dice-area">
      <!-- 5ä¸ªéª°å­ç”±jsåŠ¨æ€ç”Ÿæˆ -->
    </div>
    <div id="rollActionBtn" class="roll-btn">æ‰”</div>
  </div>

  <!-- ä¸‹éƒ¨åŒºåŸŸï¼šå½“å‰è§’è‰²åˆ—è¡¨ï¼ˆå¸¦å¼€æŒ‰é’®ï¼‰ + è§’è‰²é€‰æ‹©æ“ä½œåŒº -->
  <div class="bottom-panel">
    <div class="role-list-title">
      <span><i class="fa fa-male"></i> æœ¬å±€è§’è‰²Â·å¼€ç‰Œ</span>
      <span id="gamePhaseInfo" style="color:#ffd966;">ç­‰å¾…å¼€å±€</span>
    </div>
    <div id="roleGameList" class="current-roles">
      <!-- åŠ¨æ€ç”Ÿæˆå‚ä¸è§’è‰²åŠâ€œå¼€â€æŒ‰é’® -->
    </div>
    <div class="role-selector" id="roleSelectorArea">
      <span style="color:#ffe3a0; font-size:0.8rem;">é€‰è§’:</span>
      <!-- äº”ä¸ªè§’è‰²æŒ‰é’®ç”±jsç”Ÿæˆ -->
    </div>
  </div>
</div>

<script>
  (function(){
    // ---------- å…¨å±€å˜é‡ & socket åˆå§‹åŒ– ----------
    const socket = io();

    // å½“å‰å®¢æˆ·ç«¯çŠ¶æ€
    let myRole = null;                // æˆ‘è‡ªå·±é€‰æ‹©çš„è§’è‰²(nullè¡¨ç¤ºæœªé€‰)
    let allPlayers = [];            // å½“å‰æ‰€æœ‰åœ¨çº¿è§’è‰² [{ role, id }]
    let roundDicePoints = {};       // æœ¬è½®å„ä¸ªè§’è‰²çš„éª°å­ç‚¹æ•° { role: [d1,d2,d3,d4,d5] }
    let isRolling = false;         // æ˜¯å¦æ­£åœ¨åŠ¨ç”»ä¸­
    let rollTimer = null;         
    let kaiVisibleTimer = null;   
    let currentDisplayRole = null; // ä¸­éƒ¨éª°å­æ­£åœ¨å±•ç¤ºè°çš„ç‚¹æ•°
    let isAllReadyTriggered = false; // é˜²æ­¢é‡å¤è§¦å‘

    // äº”ä¸ªå›ºå®šè§’è‰²
    const FIXED_ROLES = ['å»ºå¹¿', 'å»ºå›½', 'æå·', 'å‡¯å®', 'é¸¿æ™“'];
    // å½“å‰æœåŠ¡å™¨å·²å ç”¨çš„è§’è‰²ï¼ŒåŒæ­¥äº allPlayers
    let occupiedRoles = [];

    // ---------- DOM å…ƒç´  ----------
    const onlineListDiv = document.getElementById('onlineList');
    const diceContainer = document.getElementById('diceContainer');
    const rollBtn = document.getElementById('rollActionBtn');
    const roleGameListDiv = document.getElementById('roleGameList');
    const roleSelectorArea = document.getElementById('roleSelectorArea');
    const gamePhaseInfo = document.getElementById('gamePhaseInfo');

    // ---------- åˆå§‹åŒ–UI: 5ä¸ªéª°å­ ----------
    function initDiceUI() {
      diceContainer.innerHTML = '';
      for (let i = 0; i < 5; i++) {
        const diceDiv = document.createElement('div');
        diceDiv.className = 'dice';
        diceDiv.setAttribute('data-index', i);
        diceDiv.textContent = 'âš€'; // é»˜è®¤1ç‚¹
        diceContainer.appendChild(diceDiv);
      }
    }
    initDiceUI();

    // ---------- ç”Ÿæˆè§’è‰²é€‰æ‹©æŒ‰é’® ----------
    function renderRoleSelector() {
      const occupied = allPlayers.map(p => p.role);
      let html = '';
      FIXED_ROLES.forEach(role => {
        const isOccupied = occupied.includes(role);
        const isMe = myRole === role;
        // å¯ç”¨æ¡ä»¶: æœªè¢«å ç”¨ ä¸” æˆ‘è¿˜æ²¡é€‰è§’è‰²
        const available = !isOccupied && !myRole;
        // å¦‚æœæ˜¯æˆ‘è‡ªå·±ï¼Œæ˜¾ç¤ºå·²é€‰ï¼Œä¸å¯å†ç‚¹
        const cls = `role-btn ${available ? 'available' : 'disabled'}`;
        html += `<div class="${cls}" data-role="${role}">${role} ${isMe ? 'âœ“' : (isOccupied ? 'âš”ï¸' : '')}</div>`;
      });
      roleSelectorArea.innerHTML = `<span style="color:#ffe3a0; font-size:0.8rem;">é€‰è§’:</span>` + html;
    }

    // ---------- æ›´æ–°ä¸Šéƒ¨åœ¨çº¿åˆ—è¡¨ (åªæ˜¾ç¤ºå·²é€‰è§’è‰²ç©å®¶) ----------
    function renderOnlinePlayers() {
      if (allPlayers.length === 0) {
        onlineListDiv.innerHTML = '<span class="empty-tip">æš‚æ— ç©å®¶ï¼Œå¿«é€‰è§’è‰²åŠ å…¥å§</span>';
        return;
      }
      let str = '';
      allPlayers.forEach(p => {
        str += `<div class="player-badge"><i class="fa fa-user-circle"></i> ${p.role}</div>`;
      });
      onlineListDiv.innerHTML = str;
    }

    // ---------- æ¸²æŸ“ä¸‹éƒ¨è§’è‰²åˆ—è¡¨(å¸¦å¼€æŒ‰é’®)ï¼Œå¹¶æ ¹æ®15ç§’æ§åˆ¶æ˜¾éš ----------
    function renderRoleGameList(showKai = false) {
      if (allPlayers.length === 0) {
        roleGameListDiv.innerHTML = '<span style="color:#c7b58b;">æš‚æ— è§’è‰²</span>';
        return;
      }
      let html = '';
      // æŒ‰ç…§å›ºå®šè§’è‰²é¡ºåºå±•ç¤ºï¼Œæ›´æ•´é½
      FIXED_ROLES.forEach(role => {
        const player = allPlayers.find(p => p.role === role);
        if (!player) return; // ä¸åœ¨çº¿ä¸æ˜¾ç¤º
        const hasDice = roundDicePoints && roundDicePoints[role]; // æœ¬è½®æ˜¯å¦æœ‰éª°å­ç‚¹æ•°
        // æ˜¯å¦æ˜¾ç¤ºå¼€æŒ‰é’®: éª°å­åœæ­¢å15ç§’ä¸ºtrue, å¹¶ä¸”å½“å‰æœ‰è¯¥è§’è‰²ç‚¹æ•°
        const kaiVisible = showKai && hasDice;
        // æˆ‘è‡ªå·±ä¸å¯ç‚¹è‡ªå·±çš„å¼€? å…è®¸ç‚¹å‡»ï¼Œä½†ç”¨äºæŸ¥çœ‹ï¼›éƒ½å¯ä»¥
        const isActiveRole = (currentDisplayRole === role);
        const activeStyle = isActiveRole ? 'border: 3px solid #ffd966; background:#4a412a;' : '';
        html += `<div class="role-item" style="${activeStyle}">
                    <i class="fa fa-male"></i> ${role}`;
        if (hasDice) {
          html += `<span style="color:#eac358;font-size:0.7rem;">ğŸ²å·²æŠ•</span>`;
        }
        // å¼€æŒ‰é’®: é»˜è®¤éšè—ï¼ŒshowKai ä¸º true æ—¶æ˜¾ç¤º
        if (kaiVisible) {
          html += `<button class="kai-btn" data-role="${role}">å¼€</button>`;
        } else {
          // å ä½éšè—ï¼Œä¸ºäº†ä¸å˜å¸ƒå±€ ä¸æ˜¾ç¤ºæŒ‰é’®
        }
        html += `</div>`;
      });
      if (html === '') html = '<span style="color:#c7b58b;">æš‚æ— åœ¨çº¿è§’è‰²</span>';
      roleGameListDiv.innerHTML = html;

      // ç»‘å®šâ€œå¼€â€æŒ‰é’®äº‹ä»¶
      if (showKai) {
        document.querySelectorAll('.kai-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const targetRole = this.dataset.role;
            if (roundDicePoints[targetRole]) {
              // åˆ‡æ¢ä¸­éƒ¨éª°å­æ˜¾ç¤ºä¸ºç›®æ ‡è§’è‰²çš„ç‚¹æ•°
              setDiceFaces(roundDicePoints[targetRole]);
              currentDisplayRole = targetRole;
              // åˆ·æ–°é«˜äº®æ ·å¼
              renderRoleGameList(true);
            }
          });
        });
      }
    }

    // è¾…åŠ©: è®¾ç½®5ä¸ªéª°å­ç•Œé¢ç‚¹æ•°
    function setDiceFaces(diceArray) {
      const diceDivs = document.querySelectorAll('.dice');
      if (!diceArray || diceArray.length < 5) return;
      diceDivs.forEach((div, idx) => {
        const val = diceArray[idx];
        div.textContent = getDiceFace(val);
      });
    }

    // æ•°å­—1-6è½¬éª°å­å­—ç¬¦
    function getDiceFace(val) {
      const faces = ['âš€', 'âš', 'âš‚', 'âšƒ', 'âš„', 'âš…'];
      return faces[val-1] || 'âš€';
    }

    // ---------- éª°å­æ»šåŠ¨åŠ¨ç”» ----------
    function startRollAnimation() {
      if (rollTimer) clearInterval(rollTimer);
      isRolling = true;
      rollBtn.classList.add('disabled');
      // åŠ¨ç”»: å¿«é€Ÿéšæœºå˜åŒ–
      rollTimer = setInterval(() => {
        const diceDivs = document.querySelectorAll('.dice');
        diceDivs.forEach(div => {
          const rand = Math.floor(Math.random() * 6) + 1;
          div.textContent = getDiceFace(rand);
        });
      }, 80);
    }

    function stopRollAnimationAndShow(role) {
      if (rollTimer) {
        clearInterval(rollTimer);
        rollTimer = null;
      }
      isRolling = false;
      // æ˜¾ç¤ºè¯¥è§’è‰²çš„ç‚¹æ•°
      if (role && roundDicePoints[role]) {
        setDiceFaces(roundDicePoints[role]);
        currentDisplayRole = role;
      } else {
        // é™çº§: å¦‚æœå½“å‰æ²¡æœ‰è§’è‰²ç‚¹æ•°(æå°æ¦‚ç‡) æ˜¾ç¤ºé»˜è®¤
      }
    }

    // ---------- é‡ç½®æœ¬è½®å°±ç»ªç›¸å…³(å‡†å¤‡ä¸‹ä¸€è½®) æ­¤å¤„ç®€åŒ–ï¼Œå¯é‡æ–°æ‰”--------
    function resetForNextRound() {
      // ä¸æ¸…é™¤ç‚¹æ•°ï¼Œä½†15ç§’å¼€æŒ‰é’®ä¼šæ¶ˆå¤±ï¼Œç”±æœåŠ¡å™¨é‡æ–°æ§åˆ¶
    }

    // ---------- socket äº‹ä»¶ç›‘å¬ ----------
    socket.on('connect', () => {
      console.log('socket connected', socket.id);
    });

    // æœåŠ¡å™¨æ¨é€æœ€æ–°ç©å®¶åˆ—è¡¨
    socket.on('playersUpdate', (players) => {
      allPlayers = players || [];
      occupiedRoles = allPlayers.map(p => p.role);
      // è‹¥æˆ‘çš„è§’è‰²ä¸åœ¨é‡Œé¢ï¼Œè¯´æ˜æˆ‘è¢«è¸¢å‡ºæˆ–æ‰çº¿ï¼Œæ¸…ç©ºmyRole
      if (myRole && !allPlayers.find(p => p.role === myRole)) {
        myRole = null;
        // å¼ºåˆ¶åˆ·æ–°
      }
      renderOnlinePlayers();
      renderRoleSelector();
      // ä¸‹éƒ¨è§’è‰²åˆ—è¡¨æ¸²æŸ“ï¼ˆä¿ç•™å¼€æŒ‰é’®çŠ¶æ€ï¼Œä½†æ­¤å¤„éœ€è¦çŸ¥é“æ˜¯å¦åº”è¯¥æ˜¾ç¤ºå¼€ï¼Œç”±æœåŠ¡å™¨æ ‡å¿—ï¼Œæˆ‘ä»¬å€ŸåŠ©gamePhaseï¼‰
      // ç›®å‰ä¿æŒåŸå¼€æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€ï¼Œç”±ä¸‹é¢diceStoppedäº‹ä»¶è§¦å‘15sè®¡æ—¶å™¨å†³å®šã€‚
    });

    // é€‰æ‹©è§’è‰²ç»“æœåé¦ˆ
    socket.on('roleAssigned', ({ success, role, message }) => {
      if (success) {
        myRole = role;
        currentDisplayRole = role; // åˆå§‹æ˜¾ç¤ºè‡ªå·±çš„éª°å­(å¦‚æœæœ‰)
        renderRoleSelector();
        // å¦‚æœå·²æœ‰ç‚¹æ•°ï¼Œæ˜¾ç¤ºè‡ªå·±çš„
        if (roundDicePoints && roundDicePoints[role]) {
          setDiceFaces(roundDicePoints[role]);
          currentDisplayRole = role;
        }
      } else {
        alert(message || 'è§’è‰²é€‰æ‹©å¤±è´¥ï¼Œå¯èƒ½å·²è¢«é€‰èµ°');
      }
    });

    // æ”¶åˆ°æœåŠ¡å™¨é€šçŸ¥ï¼šæ‰€æœ‰ç©å®¶å·²æ‰”ï¼Œå¼€å§‹æ·éª°å­ï¼
    socket.on('startRoll', ({ roundPoints }) => {
      // roundPoints: { å»ºå¹¿: [1,3,5,2,6], ... } æ‰€æœ‰è§’è‰²ç‚¹æ•°
      roundDicePoints = roundPoints || {};
      isAllReadyTriggered = false;

      // 1. å¼€å§‹åŠ¨ç”»
      startRollAnimation();
      gamePhaseInfo.innerText = 'ğŸ² éª°å­æ»šåŠ¨ä¸­...';

      // 2. è®¾å®š2.6ç§’ååœæ­¢åŠ¨ç”» (åŒæ—¶æ˜¾ç¤ºå½“å‰æ˜¾ç¤ºè§’è‰²çš„ç‚¹æ•°)
      setTimeout(() => {
        if (isRolling) {
          stopRollAnimationAndShow(myRole); // é»˜è®¤æ˜¾ç¤ºæˆ‘è‡ªå·±çš„ç‚¹æ•°
          gamePhaseInfo.innerText = 'ğŸ² ç‚¹æ•°å·²å®š Â· 15ç§’åå¼€ç‰Œ';
          // å¯åŠ¨15ç§’åæ˜¾ç¤ºå¼€æŒ‰é’®
          if (kaiVisibleTimer) clearTimeout(kaiVisibleTimer);
          kaiVisibleTimer = setTimeout(() => {
            // æ‰€æœ‰è§’è‰²æ—è¾¹å‡ºç°"å¼€"
            renderRoleGameList(true);  // æ˜¾ç¤ºå¼€æŒ‰é’®
            gamePhaseInfo.innerText = 'ğŸ‘† ç‚¹å‡»â€œå¼€â€æŸ¥çœ‹ä»–äººéª°å­';
          }, 15000); // 15s
        }
      }, 2600); // åŠ¨ç”»æŒç»­2.6s
    });

    // æ–°ç©å®¶ç‚¹å‡»æ‰”ï¼ŒæœåŠ¡å™¨è½¬å‘readyçŠ¶æ€ï¼Œä½†æ— é¡»å‰ç«¯é¢å¤–å¤„ç†
    socket.on('someoneReady', ({ role }) => {
      // å¯ä»¥æç¤ºï¼Œç•¥
    });

    // é”™è¯¯/é€šçŸ¥
    socket.on('errorMsg', ({ message }) => {
      alert(message);
    });

    // ---------- ç•Œé¢äº¤äº’: ç‚¹å‡»æ‰”æŒ‰é’® ----------
    rollBtn.addEventListener('click', () => {
      if (!myRole) {
        alert('è¯·å…ˆé€‰æ‹©è§’è‰²ï¼');
        return;
      }
      if (isRolling) {
        alert('éª°å­æ­£åœ¨æ»šåŠ¨ï¼Œè¯·ç¨å');
        return;
      }
      // é€šçŸ¥æœåŠ¡å™¨ï¼šæˆ‘å‡†å¤‡å¥½æ‰”äº†
      socket.emit('playerReady', { role: myRole });
    });

    // ---------- è§’è‰²é€‰æ‹©: é€šè¿‡äº‹ä»¶å§”æ‰˜ ----------
    roleSelectorArea.addEventListener('click', (e) => {
      const target = e.target.closest('.role-btn');
      if (!target) return;
      if (target.classList.contains('disabled') && !target.classList.contains('available')) return;
      const role = target.dataset.role;
      if (!role) return;
      if (myRole) {
        alert('ä½ å·²ç»é€‰æ‹©è¿‡è§’è‰²äº†ï¼Œä¸èƒ½æ›´æ¢');
        return;
      }
      // æ£€æŸ¥æ˜¯å¦å·²å ç”¨
      if (occupiedRoles.includes(role)) {
        alert('æ­¤è§’è‰²å·²è¢«é€‰èµ°');
        return;
      }
      // å‘é€é€‰æ‹©è§’è‰²
      socket.emit('selectRole', { role });
    });

    // åˆå§‹åŒ–è§’è‰²é€‰æ‹©å™¨
    renderRoleSelector();
    // è¯·æ±‚åˆå§‹åˆ—è¡¨
    socket.on('connect', () => {
      // è§¦å‘æ›´æ–°
    });

    // ç›‘å¬æ–­å¼€ç­‰
    window.addEventListener('beforeunload', () => {
      socket.disconnect();
    });

  })();
</script>

<!-- åç«¯éƒ¨åˆ†å°†æä¾›Socket.IOæœåŠ¡ï¼Œéœ€å°†ä»¥ä¸‹ä»£ç ä¿å­˜ä¸ºserver.jsä½¿ç”¨nodeè¿è¡Œï¼Œæ­¤å¤„ä¸ºå‰ç«¯å…¼å®¹ç¤ºæ„ï¼Œå®é™…ä¸€ä½“å¯ç”¨ã€‚  
     ä¸ºå®Œæˆå±•ç¤ºï¼Œéœ€åœ¨ä¸‹æ–¹å†…åµŒåç«¯ä»£ç é€»è¾‘ï¼ˆçº¯å‰ç«¯æ— æ³•å¤šäººåœ¨çº¿ï¼‰ï¼Œå»ºè®®å°†æ­¤æ–‡æœ¬ä¿å­˜ä¸º index.htmlï¼Œå¹¶é…åˆserver.jsã€‚
     å®Œæ•´åŠŸèƒ½éœ€è¿è¡ŒNodeæœåŠ¡å™¨ã€‚
-->
</body>
</html>